#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë         üöÄ OLYSACHECK - G√âN√âRATEUR DE SITEMAP ULTRA-PUISSANT v3.1           ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  üëë Version CORRIG√âE - 100% compatible Google                               ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  ‚úÖ CORRECTIFS APPLIQU√âS :                                                   ‚ïë
‚ïë  ‚úì Format XML maintenant PARFAIT                                             ‚ïë
‚ïë  ‚úì Plus d'erreur "fichier HTML"                                              ‚ïë
‚ïë  ‚úì Images et vid√©os optionnelles (d√©sactiv√©es par d√©faut)                    ‚ïë
‚ïë  ‚úì Validation Google renforc√©e                                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"""

import os
import glob
import gzip
import hashlib
from datetime import datetime
from xml.etree.ElementTree import Element, SubElement, tostring, register_namespace
from xml.dom import minidom
import urllib.parse
import json
import logging
from typing import List, Dict, Tuple, Optional

# =============================================================
# üéØ CONFIGURATION CORRIG√âE
# =============================================================

class SitemapConfig:
    # üîó URL de base (AVEC HTTPS)
    BASE_URL = "https://olysacheck.vercel.app"
    
    # üìÅ Extensions √† scanner (uniquement les vraies pages)
    FILE_EXTENSIONS = ['*.html', '*.php']
    
    # üñºÔ∏è Images √† inclure (optionnel - mettre False si pas d'images)
    INCLUDE_IMAGES = False  # ‚Üê CHANGE √Ä True SI TU AS DES IMAGES
    IMAGE_EXTENSIONS = ['*.jpg', '*.jpeg', '*.png', '*.gif', '*.webp', '*.svg']
    
    # üé• Vid√©os √† inclure (optionnel)
    INCLUDE_VIDEOS = False  # ‚Üê CHANGE √Ä True SI TU AS DES VID√âOS
    VIDEO_EXTENSIONS = ['*.mp4', '*.webm', '*.ogg']
    
    # üìù Fichiers √† exclure
    EXCLUDED_FILES = [
        '404.html', 'error.html', 'thanks.html',
        'old/', 'backup/', 'temp/', 'private/',
        'robots.txt', 'sitemap.xml', 'sitemap.xml.gz', 'sitemap.html'
    ]
    
    # üèÜ Priorit√©s (corrig√©es)
    PAGE_PRIORITIES = {
        'index.html': '1.0',
        'check-email.php': '0.9',
        'auth.html': '0.8',
        'politique-confidentialite.html': '0.7',
    }
    
    # üîÑ Fr√©quences (corrig√©es)
    PAGE_FREQUENCY = {
        'index.html': 'daily',
        'check-email.php': 'always',
        'auth.html': 'weekly',
        'politique-confidentialite.html': 'monthly',
    }
    
    # üåç Langues (d√©sactiv√© par d√©faut)
    INCLUDE_LANGUAGES = False
    LANGUAGES = ['fr', 'en']
    
    # üóìÔ∏è Format de date SIMPLE (YYYY-MM-DD)
    DATE_FORMAT = "%Y-%m-%d"
    
    # üìä Logging
    LOG_FILE = "sitemap_generation.log"
    LOG_LEVEL = logging.INFO


# =============================================================
# üìù G√âN√âRATEUR CORRIG√â
# =============================================================

class GoogleFriendlySitemapGenerator:
    """
    G√©n√©rateur CORRIG√â - 100% compatible Google
    """
    
    def __init__(self, config: SitemapConfig):
        self.config = config
        self.files_found = []
        self.images_found = []
        self.videos_found = []
        self.stats = {
            'total_files': 0,
            'total_images': 0,
            'total_videos': 0,
            'included_urls': 0,
            'included_images': 0,
            'included_videos': 0,
            'excluded': 0,
            'errors': 0
        }
        self.setup_logging()
        
        # Namespaces XML (gard√©s mais utilis√©s seulement si n√©cessaire)
        if self.config.INCLUDE_IMAGES:
            register_namespace('image', 'http://www.google.com/schemas/sitemap-image/1.1')
        if self.config.INCLUDE_VIDEOS:
            register_namespace('video', 'http://www.google.com/schemas/sitemap-video/1.1')
        if self.config.INCLUDE_LANGUAGES:
            register_namespace('xhtml', 'http://www.w3.org/1999/xhtml')
        
    def setup_logging(self):
        logging.basicConfig(
            level=self.config.LOG_LEVEL,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(self.config.LOG_FILE),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger("SitemapGenerator")
        
    def scan_files(self):
        """Scan intelligent des fichiers"""
        self.logger.info("üîç Scan des fichiers en cours...")
        
        # Scan des pages UNIQUEMENT
        for ext in self.config.FILE_EXTENSIONS:
            found = glob.glob(ext, recursive=False)  # PAS r√©cursif
            self.files_found.extend(found)
            
        # Scan des images (optionnel)
        if self.config.INCLUDE_IMAGES:
            for ext in self.config.IMAGE_EXTENSIONS:
                found = glob.glob(ext, recursive=False)
                self.images_found.extend(found)
            
        # Scan des vid√©os (optionnel)
        if self.config.INCLUDE_VIDEOS:
            for ext in self.config.VIDEO_EXTENSIONS:
                found = glob.glob(ext, recursive=False)
                self.videos_found.extend(found)
        
        self.stats['total_files'] = len(self.files_found)
        self.stats['total_images'] = len(self.images_found)
        self.stats['total_videos'] = len(self.videos_found)
        
        self.logger.info(f"   ‚úÖ {self.stats['total_files']} pages trouv√©es")
        if self.config.INCLUDE_IMAGES:
            self.logger.info(f"   ‚úÖ {self.stats['total_images']} images trouv√©es")
        if self.config.INCLUDE_VIDEOS:
            self.logger.info(f"   ‚úÖ {self.stats['total_videos']} vid√©os trouv√©es")
        
    def should_exclude(self, filename: str) -> bool:
        """V√©rifie si un fichier doit √™tre exclu"""
        for excluded in self.config.EXCLUDED_FILES:
            if excluded in filename:
                return True
        return False
    
    def get_file_info(self, filename: str) -> Dict:
        """R√©cup√®re les infos avec date SIMPLE"""
        try:
            stat = os.stat(filename)
            return {
                'modified': datetime.fromtimestamp(stat.st_mtime).strftime(self.config.DATE_FORMAT),
                'exists': True
            }
        except Exception as e:
            self.logger.warning(f"‚ö†Ô∏è Erreur sur {filename}: {e}")
            return {
                'modified': datetime.now().strftime(self.config.DATE_FORMAT),
                'exists': False
            }
    
    def get_priority(self, filename: str) -> str:
        """Priorit√© en string (pour XML)"""
        return self.config.PAGE_PRIORITIES.get(filename, '0.5')
    
    def get_frequency(self, filename: str) -> str:
        """Fr√©quence en string"""
        return self.config.PAGE_FREQUENCY.get(filename, 'weekly')
    
    def generate_xml(self) -> bytes:
        """G√©n√®re le XML CORRIG√â (sans erreurs)"""
        self.logger.info("üìù G√©n√©ration du XML corrig√©...")
        
        # Cr√©ation de la racine - UNIQUEMENT le namespace obligatoire
        urlset = Element('urlset')
        urlset.set('xmlns', 'http://www.sitemaps.org/schemas/sitemap/0.9')
        
        # Ajout conditionnel des autres namespaces
        if self.config.INCLUDE_IMAGES:
            urlset.set('xmlns:image', 'http://www.google.com/schemas/sitemap-image/1.1')
        if self.config.INCLUDE_VIDEOS:
            urlset.set('xmlns:video', 'http://www.google.com/schemas/sitemap-video/1.1')
        if self.config.INCLUDE_LANGUAGES:
            urlset.set('xmlns:xhtml', 'http://www.w3.org/1999/xhtml')
        
        # Pour chaque page
        for filename in sorted(self.files_found):
            if self.should_exclude(filename):
                self.stats['excluded'] += 1
                continue
                
            file_info = self.get_file_info(filename)
            
            # Cr√©ation de l'URL
            url = SubElement(urlset, 'url')
            
            # LOC - avec HTTPS
            loc = SubElement(url, 'loc')
            encoded_filename = urllib.parse.quote(filename)
            loc.text = f"{self.config.BASE_URL}/{encoded_filename}"
            
            # LASTMOD - date simple
            lastmod = SubElement(url, 'lastmod')
            lastmod.text = file_info['modified']
            
            # CHANGEFREQ
            changefreq = SubElement(url, 'changefreq')
            changefreq.text = self.get_frequency(filename)
            
            # PRIORITY
            priority = SubElement(url, 'priority')
            priority.text = self.get_priority(filename)
            
            # HREFLANG (optionnel)
            if self.config.INCLUDE_LANGUAGES:
                for lang in self.config.LANGUAGES:
                    link = SubElement(url, '{http://www.w3.org/1999/xhtml}link')
                    link.set('rel', 'alternate')
                    link.set('hreflang', lang)
                    link.set('href', f"{self.config.BASE_URL}/{encoded_filename}?lang={lang}")
            
            # IMAGES (optionnel)
            if self.config.INCLUDE_IMAGES:
                page_images = [img for img in self.images_found 
                              if os.path.splitext(img)[0] == os.path.splitext(filename)[0]]
                
                for img in page_images[:10]:
                    image = SubElement(url, '{http://www.google.com/schemas/sitemap-image/1.1}image')
                    
                    img_loc = SubElement(image, '{http://www.google.com/schemas/sitemap-image/1.1}loc')
                    img_loc.text = f"{self.config.BASE_URL}/{urllib.parse.quote(img)}"
                    
                    self.stats['included_images'] += 1
            
            # VID√âOS (optionnel)
            if self.config.INCLUDE_VIDEOS:
                page_videos = [vid for vid in self.videos_found 
                              if os.path.splitext(vid)[0] == os.path.splitext(filename)[0]]
                
                for vid in page_videos[:5]:
                    video = SubElement(url, '{http://www.google.com/schemas/sitemap-video/1.1}video')
                    
                    vid_loc = SubElement(video, '{http://www.google.com/schemas/sitemap-video/1.1}content_loc')
                    vid_loc.text = f"{self.config.BASE_URL}/{urllib.parse.quote(vid)}"
                    
                    self.stats['included_videos'] += 1
            
            self.stats['included_urls'] += 1
        
        # Conversion en XML propre
        rough_string = tostring(urlset, 'utf-8')
        reparsed = minidom.parseString(rough_string)
        xml_string = reparsed.toprettyxml(indent="  ", encoding='utf-8')
        
        # Nettoyage des lignes vides (important)
        clean_xml = b'\n'.join([line for line in xml_string.split(b'\n') if line.strip()])
        
        return clean_xml
    
    def save_sitemap(self, xml_content: bytes) -> bool:
        """Sauvegarde le sitemap"""
        try:
            # Version normale
            with open('sitemap.xml', 'wb') as f:
                f.write(xml_content)
            self.logger.info(f"‚úÖ sitemap.xml sauvegard√© ({len(xml_content)} octets)")
            
            # Version compress√©e (optionnelle)
            with gzip.open('sitemap.xml.gz', 'wb') as f:
                f.write(xml_content)
            self.logger.info(f"‚úÖ sitemap.xml.gz sauvegard√©")
            
            return True
        except Exception as e:
            self.logger.error(f"‚ùå Erreur sauvegarde: {e}")
            return False
    
    def generate_robotstxt(self) -> bool:
        """G√©n√®re un robots.txt simple mais efficace"""
        robots_content = f"""# robots.txt pour OlysaCheck
# G√©n√©r√© le {datetime.now().strftime("%d/%m/%Y")}

User-agent: *
Allow: /
Disallow: /api/
Disallow: /private/
Disallow: /temp/
Disallow: /backup/

Sitemap: {self.config.BASE_URL}/sitemap.xml
"""
        try:
            with open('robots.txt', 'w', encoding='utf-8') as f:
                f.write(robots_content)
            self.logger.info("‚úÖ robots.txt sauvegard√©")
            return True
        except Exception as e:
            self.logger.error(f"‚ùå Erreur robots.txt: {e}")
            return False
    
    def generate_html_sitemap(self) -> bool:
        """G√©n√®re un sitemap HTML pour les humains"""
        html_content = f"""<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan du site - OlysaCheck</title>
</head>
<body>
    <h1>üó∫Ô∏è Plan du site OlysaCheck</h1>
    <ul>
"""
        for filename in sorted(self.files_found):
            if self.should_exclude(filename):
                continue
            html_content += f'        <li><a href="{filename}">{filename}</a></li>\n'
        
        html_content += """    </ul>
</body>
</html>"""
        
        try:
            with open('sitemap.html', 'w', encoding='utf-8') as f:
                f.write(html_content)
            self.logger.info("‚úÖ sitemap.html sauvegard√©")
            return True
        except Exception as e:
            self.logger.error(f"‚ùå Erreur sitemap.html: {e}")
            return False
    
    def validate_with_google(self, xml_content: bytes) -> Dict:
        """Validation Google renforc√©e"""
        self.logger.info("üîç Validation Google en cours...")
        
        issues = []
        warnings = []
        
        # V√©rification 1: Taille
        if len(xml_content) > 50 * 1024 * 1024:
            issues.append("‚ùå Sitemap trop volumineux")
        else:
            warnings.append("‚úÖ Taille OK")
        
        # V√©rification 2: Nombre d'URLs
        url_count = xml_content.count(b'<url>')
        if url_count > 50000:
            issues.append(f"‚ùå Trop d'URLs ({url_count})")
        else:
            warnings.append(f"‚úÖ {url_count} URLs")
        
        # V√©rification 3: Pr√©sence du namespace
        if b'xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"' in xml_content:
            warnings.append("‚úÖ Namespace correct")
        else:
            issues.append("‚ùå Namespace manquant")
        
        # V√©rification 4: Pas de HTML
        if b'<!DOCTYPE html>' in xml_content or b'<html' in xml_content:
            issues.append("‚ùå Le fichier contient du HTML !")
        else:
            warnings.append("‚úÖ Pas de HTML d√©tect√©")
        
        result = {
            'valid': len(issues) == 0,
            'issues': issues,
            'warnings': warnings,
            'url_count': url_count,
            'size_kb': len(xml_content) / 1024
        }
        
        return result
    
    def show_stats(self, validation_result: Dict):
        """Affiche les statistiques"""
        print("\n" + "="*60)
        print("üìä RAPPORT D√âTAILL√â - G√âN√âRATION SITEMAP")
        print("="*60)
        print(f"üìÅ Pages trouv√©es         : {self.stats['total_files']}")
        print(f"‚úÖ URLs incluses           : {self.stats['included_urls']}")
        print(f"‚è≠Ô∏è  Exclus                  : {self.stats['excluded']}")
        print("-"*60)
        print(f"üìè Taille sitemap          : {validation_result['size_kb']:.2f} KB")
        print(f"üî¢ Nombre d'URLs           : {validation_result['url_count']}")
        print("-"*60)
        print("üîç VALIDATION GOOGLE :")
        for w in validation_result['warnings']:
            print(f"   {w}")
        for i in validation_result['issues']:
            print(f"   ‚ùå {i}")
        print("="*60)
        print(f"üåê URL finale              : {self.config.BASE_URL}/sitemap.xml")
        print("="*60)
        
    def run(self):
        """Ex√©cute le processus complet"""
        print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     üöÄ G√âN√âRATION SITEMAP CORRIG√âE POUR GOOGLE v3.1               ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  ‚úÖ Plus d'erreur "fichier HTML"                                   ‚ïë
‚ïë  ‚úÖ Format XML 100% valide                                         ‚ïë
‚ïë  ‚úÖ Pr√™t pour Google Search Console                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        """)
        
        # Scan
        self.scan_files()
        
        # G√©n√©ration XML
        xml_content = self.generate_xml()
        
        # Sauvegarde
        if self.save_sitemap(xml_content):
            self.logger.info("‚úÖ Sitemap sauvegard√©")
        else:
            self.logger.error("‚ùå √âchec sauvegarde")
            self.stats['errors'] += 1
        
        # Fichiers annexes
        self.generate_robotstxt()
        self.generate_html_sitemap()
        
        # Validation
        validation = self.validate_with_google(xml_content)
        
        # Statistiques
        self.show_stats(validation)
        
        if validation['valid']:
            print("\n" + "‚úÖ"*20)
            print("üéâ SUCC√àS ! SITEMAP PARFAIT POUR GOOGLE !")
            print("‚úÖ"*20)
        else:
            print("\n" + "‚ö†Ô∏è"*20)
            print("üîß CORRECTIONS N√âCESSAIRES :")
            for i in validation['issues']:
                print(f"   {i}")
            print("‚ö†Ô∏è"*20)
        
        print(f"""
üì§ FICHIERS CR√â√âS :
   - sitemap.xml        (√Ä UPLOADER)
   - robots.txt         (√Ä UPLOADER)
   - sitemap.html       (optionnel)

üåê √Ä SOUMETTRE DANS GOOGLE :
   {self.config.BASE_URL}/sitemap.xml

üöÄ BONNE CHANCE !
        """)


if __name__ == "__main__":
    generator = GoogleFriendlySitemapGenerator(SitemapConfig())
    generator.run()