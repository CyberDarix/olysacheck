#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ğŸš€ OLYSACHECK - GÃ‰NÃ‰RATEUR DE SITEMAP ULTRA-PUISSANT v3.2           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ‘‘ Version FINALE - 100% compatible Google                                 â•‘
â•‘                                                                              â•‘
â•‘  âœ… CORRECTIONS ULTIMES :                                                    â•‘
â•‘  âœ“ FORMAT XML ABSOLUMENT PARFAIT                                             â•‘
â•‘  âœ“ PLUS D'ERREUR "FICHIER HTML"                                              â•‘
â•‘  âœ“ VALIDATION GOOGLE RENFORCÃ‰E                                               â•‘
â•‘  âœ“ PRÃŠT EN 2 MINUTES                                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

import os
import glob
import gzip
from datetime import datetime
from xml.etree.ElementTree import Element, SubElement, tostring, register_namespace
from xml.dom import minidom
import urllib.parse
import logging

# =============================================================
# ğŸ¯ CONFIGURATION SIMPLE ET EFFICACE
# =============================================================

class SitemapConfig:
    BASE_URL = "https://olysacheck.vercel.app"
    FILE_EXTENSIONS = ['*.html', '*.php']
    EXCLUDED_FILES = ['404.html', 'error.html', 'thanks.html']
    
    PAGE_PRIORITIES = {
        'index.html': '1.0',
        'check-email.php': '0.9',
        'auth.html': '0.8',
        'politique-confidentialite.html': '0.7',
    }
    
    PAGE_FREQUENCY = {
        'index.html': 'daily',
        'check-email.php': 'always',
        'auth.html': 'weekly',
        'politique-confidentialite.html': 'monthly',
    }
    
    DATE_FORMAT = "%Y-%m-%d"
    LOG_FILE = "sitemap_generation.log"
    LOG_LEVEL = logging.INFO


# =============================================================
# ğŸ“ GÃ‰NÃ‰RATEUR ULTIME
# =============================================================

class UltimateSitemapGenerator:
    def __init__(self, config: SitemapConfig):
        self.config = config
        self.files_found = []
        self.stats = {'total': 0, 'included': 0, 'excluded': 0}
        self.setup_logging()
        
    def setup_logging(self):
        logging.basicConfig(
            level=self.config.LOG_LEVEL,
            format='%(asctime)s - %(message)s',
            handlers=[logging.FileHandler(self.config.LOG_FILE), logging.StreamHandler()]
        )
        self.logger = logging.getLogger("Sitemap")

    def scan_files(self):
        self.logger.info("ğŸ” Scan...")
        for ext in self.config.FILE_EXTENSIONS:
            self.files_found.extend(glob.glob(ext))
        self.stats['total'] = len(self.files_found)
        self.logger.info(f"   âœ… {self.stats['total']} pages")

    def should_exclude(self, filename):
        return any(excl in filename for excl in self.config.EXCLUDED_FILES)

    def get_file_info(self, filename):
        try:
            stat = os.stat(filename)
            return datetime.fromtimestamp(stat.st_mtime).strftime(self.config.DATE_FORMAT)
        except:
            return datetime.now().strftime(self.config.DATE_FORMAT)

    def generate_xml(self) -> bytes:
        self.logger.info("ğŸ“ GÃ©nÃ©ration XML...")
        
        urlset = Element('urlset')
        urlset.set('xmlns', 'http://www.sitemaps.org/schemas/sitemap/0.9')
        
        for filename in sorted(self.files_found):
            if self.should_exclude(filename):
                self.stats['excluded'] += 1
                continue
            
            lastmod = self.get_file_info(filename)
            priority = self.config.PAGE_PRIORITIES.get(filename, '0.5')
            changefreq = self.config.PAGE_FREQUENCY.get(filename, 'weekly')
            
            url = SubElement(urlset, 'url')
            
            loc = SubElement(url, 'loc')
            loc.text = f"{self.config.BASE_URL}/{urllib.parse.quote(filename)}"
            
            lastmod_elem = SubElement(url, 'lastmod')
            lastmod_elem.text = lastmod
            
            changefreq_elem = SubElement(url, 'changefreq')
            changefreq_elem.text = changefreq
            
            priority_elem = SubElement(url, 'priority')
            priority_elem.text = priority
            
            self.stats['included'] += 1
        
        rough = tostring(urlset, 'utf-8')
        reparsed = minidom.parseString(rough)
        xml = reparsed.toprettyxml(indent="  ", encoding='utf-8')
        
        # Nettoyage ULTRA-STRICT pour Ã©viter tout HTML
        clean_lines = []
        for line in xml.decode('utf-8').split('\n'):
            if line.strip() and not line.strip().startswith('<?xml') and not line.strip().startswith('<urlset'):
                clean_lines.append(line)
            elif line.strip():
                clean_lines.append(line)
        
        final_xml = ('<?xml version="1.0" encoding="UTF-8"?>\n'
                    '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n')
        
        for line in clean_lines[2:-1]:  # Ignore les 2 premiÃ¨res et derniÃ¨re lignes
            if '<url>' in line or '</url>' in line or '<loc>' in line or '<lastmod>' in line or '<changefreq>' in line or '<priority>' in line:
                final_xml += line + '\n'
        
        final_xml += '</urlset>'
        
        return final_xml.encode('utf-8')

    def save_sitemap(self, xml_content: bytes):
        with open('sitemap.xml', 'wb') as f:
            f.write(xml_content)
        self.logger.info(f"âœ… sitemap.xml ({len(xml_content)} octets)")

    def generate_robotstxt(self):
        robots = f"""# robots.txt OlysaCheck
User-agent: *
Allow: /
Disallow: /api/
Disallow: /private/
Sitemap: {self.config.BASE_URL}/sitemap.xml
"""
        with open('robots.txt', 'w', encoding='utf-8') as f:
            f.write(robots)
        self.logger.info("âœ… robots.txt")

    def validate(self, xml_content: bytes):
        self.logger.info("ğŸ” Validation...")
        content = xml_content.decode('utf-8')
        
        if '<!DOCTYPE html>' in content or '<html' in content:
            self.logger.error("âŒ FICHIER HTML DÃ‰TECTÃ‰ !")
            return False
        
        if 'xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"' not in content:
            self.logger.error("âŒ Namespace manquant")
            return False
        
        url_count = content.count('<url>')
        self.logger.info(f"âœ… {url_count} URLs valides")
        return True

    def show_stats(self):
        print("\n" + "="*50)
        print("ğŸ“Š RAPPORT FINAL")
        print("="*50)
        print(f"ğŸ“ Pages trouvÃ©es : {self.stats['total']}")
        print(f"âœ… Pages incluses : {self.stats['included']}")
        print(f"â­ï¸  Exclus        : {self.stats['excluded']}")
        print("="*50)
        print(f"ğŸŒ URL : {self.config.BASE_URL}/sitemap.xml")
        print("="*50)

    def run(self):
        print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ğŸš€ GÃ‰NÃ‰RATION SITEMAP - CORRECTION URGENTE v3.2         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """)
        
        self.scan_files()
        xml = self.generate_xml()
        self.save_sitemap(xml)
        self.generate_robotstxt()
        
        if self.validate(xml):
            print("\nâœ… SUCCÃˆS ! Plus d'erreur 'fichier HTML'")
        else:
            print("\nâŒ Ã‰CHEC - RÃ©essaie")
        
        self.show_stats()
        
        print("""
ğŸ“¤ ACTIONS IMMÃ‰DIATES :
   1. UPLOADE sitemap.xml et robots.txt sur ton serveur
   2. VÃ‰RIFIE : https://olysacheck.vercel.app/sitemap.xml
   3. RETOURNE dans Google Search Console
   4. SUPPRIME l'ancien sitemap
   5. AJOUTE : sitemap.xml
        """)


if __name__ == "__main__":
    UltimateSitemapGenerator(SitemapConfig()).run()